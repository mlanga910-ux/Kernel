#!/usr/bin/env bash
set -euo pipefail

CONFIG="${1:-}"

if [[ -z "$CONFIG" ]]; then
  echo "ERROR: missing path to .config"
  exit 1
fi

if [[ ! -f "$CONFIG" ]]; then
  echo "ERROR: config file not found at: $CONFIG"
  exit 1
fi

# Forbidden items — MTK kernel fails if these are enabled
bad_items=(
  CONFIG_BLK_DEV_NVME
  CONFIG_SCSI
  CONFIG_SCSI_SAS
  CONFIG_SCSI_DMA
  CONFIG_FB
  CONFIG_DRM
)

for item in "${bad_items[@]}"; do
  if grep -q "^${item}=y" "$CONFIG" || grep -q "^${item}=m" "$CONFIG"; then
    echo "❌ ERROR: forbidden kernel feature enabled: $item"
    exit 2
  fi
done

echo "✔ Config sanitized: OK"
exit 0
