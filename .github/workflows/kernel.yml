name: Xiaomi Kernel Build (dandelion)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install toolchain
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu bc bison flex libssl-dev make

      - name: Clone Xiaomi kernel source
        run: |
          git clone --depth=1 https://github.com/MiCode/XiaomiKernelOpenSource.git kernel
          cd kernel
          git checkout dandelion-q-oss || true

      - name: Copy custom config
        run: |
          cp ./custom.config ./kernel/.config

      - name: Make config executable
        run: |
          chmod +x scripts/check_config.sh

      - name: Sanity check config
        run: |
          ./scripts/check_config.sh ./kernel/.config

      - name: Build kernel Image.gz
        run: |
          cd kernel
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- Image.gz

      - name: Prepare AnyKernel3
        run: |
          mkdir output
          cp kernel/arch/arm64/boot/Image.gz AnyKernel3/
          cd AnyKernel3
          zip -r ../output/Kernel-Angelican.zip ./*

      - name: Upload final kernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Angelican
          path: output/Kernel-Angelican.zip
